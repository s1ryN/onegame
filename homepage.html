<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OneGame | Homepage</title>
    <link rel="stylesheet" type="text/css" href="homepage.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap">
    <script src="https://kit.fontawesome.com/b767968911.js" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="header">
        <a href="homepage.html">
            <img src="images/Onegame.png" alt="Logo" class="logo" draggable="false">
        </a>
    </div>

    <div id="post-form">
        <form action="/post" method="post" id="post" enctype="multipart/form-data">
            <textarea name="content" id="post-text" placeholder="What's on your mind?" required></textarea>
            <input type="file" name="media_url" id="post-image" accept="image/*, video/*">
            <label for="post-image" id="post-image-label" class="image-icon"><i class="fa-solid fa-images"></i>Add Image</label>
            <button type="submit">Post</button>
        </form>
    </div>

    <div id="posts"></div>

    <script>
        let isFetching = false;
        let allPostsLoaded = false;
        let page = 1;
        let postsContainer = document.getElementById('posts');

        function isYouTubeLink(text) {
            if (typeof text !== 'string') return false;
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = text.match(youtubeRegex);
            return match ? match[0] : null;
        }

        function getYouTubeVideoId(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        }

        function formatPostTime(postTime) {
            const date = new Date(postTime);
            return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()} at ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }

        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function() {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            fetchPosts();
            window.addEventListener('scroll', throttle(() => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 && !isFetching && !allPostsLoaded) {
                    fetchPosts();
                }
            }, 200));
        });

        function fetchPosts() {
            if (isFetching || allPostsLoaded) return;
            isFetching = true;
            fetch(`/api/posts?page=${page}`)
                .then(response => response.json())
                .then(posts => {
                    if (posts.length > 0) {
                        renderPosts(posts);
                        page++;
                    } else {
                        allPostsLoaded = true;
                    }
                })
                .catch(error => console.error('Error fetching posts:', error))
                .finally(() => isFetching = false);
        }

        function renderPosts(posts) {
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.classList.add('post');

                let mediaContent = '';
                if (isYouTubeLink(post.media_url)) {
                    const videoId = getYouTubeVideoId(post.media_url);
                    mediaContent = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                } else if (post.media_url) {
                    mediaContent = `<img src="/uploads/${post.media_url}" alt="Post Media">`;
                }

                postElement.innerHTML = `
                    <p><strong>${post.username}</strong></p>
                    <p>${post.content}</p>
                    ${mediaContent}
                    <p><em>Posted on ${formatPostTime(post.post_time)}</em></p>
                    <p>Likes: <span id="like-count-${post.id}">${post.like_count}</span></p>
                    <button class="like-button" data-post-id="${post.id}" onclick="handleLike(${post.id})"><i class="fa-regular fa-heart"></i> Like</button>
                    <div id="comments-${post.id}" class="comments-section" style="display:none;"></div>
                `;

                postsContainer.appendChild(postElement);
            });
        }

        function handleLike(postId) {
        const likeButton = document.querySelector(`button[data-post-id="${postId}"]`);
        const likeCountElement = document.getElementById(`like-count-${postId}`);
        let likeCount = parseInt(likeCountElement.innerText);
        
        // Determine the current state based on button class
        const isLiked = likeButton.classList.contains('liked');
        
        // Optimistically update UI
        if (isLiked) {
            likeCount = Math.max(0, likeCount - 1); // Prevent -1 count
            likeButton.classList.remove('liked');
            likeButton.innerHTML = '<i class="fa-regular fa-heart"></i> Like'; // Outline heart
        } else {
            likeCount += 1;
            likeButton.classList.add('liked');
            likeButton.innerHTML = '<i class="fa-solid fa-heart"></i> Liked'; // Filled heart
        }
        likeCountElement.innerText = likeCount;

        // Async request to update like status on the server
        fetch(isLiked ? '/unlike' : '/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ postId: postId }),
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Server-side failure, revert UI changes
                likeButton.classList.toggle('liked');
                likeCountElement.innerText = isLiked ? likeCount + 1 : likeCount - 1;
                likeButton.innerHTML = isLiked ? '<i class="fa-solid fa-heart"></i> Liked' : '<i class="fa-regular fa-heart"></i> Like';
            }
        })
        .catch(error => {
            console.error('Error liking/unliking post:', error);
            // On error, revert UI changes
            likeButton.classList.toggle('liked');
            likeCountElement.innerText = isLiked ? likeCount + 1 : likeCount - 1;
            likeButton.innerHTML = isLiked ? '<i class="fa-solid fa-heart"></i> Liked' : '<i class="fa-regular fa-heart"></i> Like';
        });
    }

    </script>
</body>
</html>
