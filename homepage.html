<!DOCTYPE html>
<html>
<head>
    <!-- Základní nastavení na UTF-8, připojení homepage.css a fontu Space Mono, nastavení title. -->
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="homepage.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap">
    <script src="https://kit.fontawesome.com/b767968911.js" crossorigin="anonymous"></script>
    <title>OneGame | Homepage</title>

    <script>
        // Move the function to the client-side script
    function isYouTubeLink(text) {
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = text.match(youtubeRegex);
        return match ? match[0] : null;
    }

    // Function for extracting YouTube video ID from the provided YouTube link
    function getYouTubeVideoId(url) {
        const match = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        return match ? match[1] : null;
    }
    </script>
    
</head>
<body>
    <!-- Header s logem stránky na proklik na homepage.html -->
    <div class="header">
        <a href="homepage.html">
            <img src="images/Onegame.png" alt="Logo" class="logo" draggable="false">
        </a>
    </div>

    <!-- Formulář pro postování -->
    <div id="post-form">
        <form action="/post" method="post" id="post" enctype="multipart/form-data">
            <!-- Textový obsah postu -->
            <textarea name="content" id="post-text" placeholder="What's on your mind?" required></textarea>
            <!-- Mediální obsah postu -->
            <input type="file" name="media_url" id="post-image" accept="image/*, video/*">
            <!-- Ikonka pro vložení mediálního obsahu -->
            <label for="post-image" id="post-image-label" class="image-icon"><i class="fa-solid fa-images"></i>Add Image</label>
            <!-- Tlačítko pro zveřejnění příspěvku -->
            <button type="submit">Post</button>
        </form>
    </div>

    <!-- Část pro zobrazení postů -->
    <div id="posts"></div>

    <!-- Skript pro zobrazení postů a jejich obsahu a jejich načtení z databáze -->
    <script>

    function formatPostTime(postTime) {
    const date = new Date(postTime);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based in JavaScript
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    function isYouTubeLink(text) {
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = text.match(youtubeRegex);
        return match ? match[0] : null;
    }

    // Function for extracting YouTube video ID from the provided YouTube link
    function getYouTubeVideoId(url) {
        const match = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        return match ? match[1] : null;
    }

    function displaycomments() {
        const comments = document.getElementById('comments');
        comments.style.display = 'block';
        //limit comment displayed when comments button clicked
        const comment = document.getElementsByClassName('comment');
        for (let i = 0; i < comment.length; i++) {
            if (i > 2) {
                comment[i].style.display = 'none';
            }
        }
    }

        let page = 1;
        const postsContainer = document.getElementById('posts');

        //Funkce pro prodloužení stránky a načtení více postů při scrollování na homepage
        function fetchPosts() {
            fetch(`/api/posts?page=${page}`)
                .then(response => response.json())
                .then(posts => {
                    if (posts.length > 0) {
                        renderPosts(posts);
                        page++;
                    }
                })
                //Konzolová chybová zpráva v případě problému při načítání postů
                .catch(error => console.error('Error fetching posts:', error));
        }

        //Funkce pro samotné načtení postů
        function renderPosts(posts) {
    if (posts && posts.length > 0) {
        posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.classList.add('post');

            postElement.innerHTML = `
                <p><strong>${post.username}</strong></p>
                <p>${post.content}</p>
                ${post.media_url ? renderMedia(post.media_url) : ''}
                <p><em>Posted on ${formatPostTime(post.post_time)}</em></p>
                <p>Likes: <span id="like-count-${post.id}">${post.like_count}</span></p>
                <button class="like-button" data-post-id="${post.id}"><i class="fa-regular fa-heart"></i> Like</button>
                <button class="comments-button" data-post-id="${post.id}"><i class="fa-regular fa-comment"></i> Comments</button>
            `;

            postsContainer.appendChild(postElement);
        });


        // Like button for liking a post
        document.querySelectorAll('.like-button').forEach(button => {
    // Remove all previous event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);

    newButton.addEventListener('click', function() {
        this.disabled = true;

        const postId = newButton.dataset.postId;
        const isRemoveLike = this.dataset.liked === 'true';

        fetch(isRemoveLike ? '/unlike' : '/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ postId }),
        })
        .then(response => {
            if (response.ok) {
                const likeCountElement = document.getElementById(`like-count-${postId}`);
                likeCountElement.textContent = parseInt(likeCountElement.textContent) + (isRemoveLike ? -1 : 1);
                this.dataset.liked = isRemoveLike ? 'false' : 'true';
                this.innerHTML = isRemoveLike ? '<i class="fa-regular fa-heart"></i> Like' : '<i class="fa-solid fa-heart"></i> Like';
                this.classList.toggle('liked');
            } else {
                console.error('Error updating like:', response.statusText);
            }
            this.disabled = false;
        })
        .catch(error => {
            console.error('Error updating like:', error);
            this.disabled = false;
        });
    });
});
    }
}

function likePost(button) {
    const postId = button.dataset.postId;

    fetch('/like', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ postId }),
    })
    .then(response => {
        if (response.ok) {
            const likeCountElement = document.getElementById(`like-count-${postId}`);
            likeCountElement.textContent = parseInt(likeCountElement.textContent) + 1;
            button.textContent = 'Remove Like';
        } else {
            console.error('Error liking post:', response.statusText);
        }
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error liking post:', error);
        button.disabled = false;
    });
}

function unlikePost(button) {
    const postId = button.dataset.postId;

    fetch('/unlike', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ postId }),
    })
    .then(response => {
        if (response.ok) {
            const likeCountElement = document.getElementById(`like-count-${postId}`);
            likeCountElement.textContent = parseInt(likeCountElement.textContent) - 1;
            button.textContent = 'Like';
        } else {
            console.error('Error unliking post:', response.statusText);
        }
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error unliking post:', error);
        button.disabled = false;
    });
}

document.querySelectorAll('.like-button').forEach(button => {
    // Remove all previous event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);

    newButton.addEventListener('click', function() {
        this.disabled = true;

        if (this.textContent === 'Remove Like') {
            unlikePost(this);
        } else {
            likePost(this);
        }
    });
});

// Function for loading media
function renderMedia(mediaUrl) {
    const baseMediaUrl = '/uploads/'; // Folder from which media is loaded
    const fullMediaUrl = `${baseMediaUrl}${mediaUrl}`;

    const fileExtension = mediaUrl.split('.').pop().toLowerCase();
    if (fileExtension === 'mp4' || fileExtension === 'webm') {
        //
        return `<video controls><source src="${fullMediaUrl}" type="video/mp4"></video>`;
    } else if (fileExtension === 'jpg' || fileExtension === 'jpeg' || fileExtension === 'png' || fileExtension === 'gif') {
        // If it's an image
        return `<img src="${fullMediaUrl}" alt="Post Media">`;
    } else if (isYouTubeLink(mediaUrl)) {
        // If it's a YouTube link
        const videoId = getYouTubeVideoId(mediaUrl);
        return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
    } else {
        // Unsupported file type
        return 'Unsupported media type';
    }
}
        // Function to check if the user has scrolled to the bottom of the page
        function isAtBottom() {
            return window.innerHeight + window.scrollY >= document.body.offsetHeight;
        }

        // Event listener for scrolling
        window.addEventListener('scroll', () => {
            if (isAtBottom()) {
                fetchPosts(); // Fetch more posts when the user reaches the bottom
            }
        });

        // Initial fetch when the page loads
        fetchPosts();

        function handleLike(postId) {
            fetch('/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ postId: postId }),
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Like successful');
                        // You may want to update the UI here, e.g., increment like count or change button appearance
                    } else {
                        console.error('Error liking post:', response.statusText);
                    }
                })
                .catch(error => console.error('Error liking post:', error));
        }
    </script>
</body>
</html>
